<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>よけゲー スマホ対応版</title>
<style>
  body { margin:0; overflow:hidden; font-family:'Segoe UI', sans-serif; }
  canvas { display:block; margin:0 auto; background:#0000; }
  #ui {
    position:absolute; top:10px; left:50%; transform:translateX(-50%);
    display:flex; gap:40px; font-size:22px;
    text-shadow:0 0 10px rgba(255,255,255,0.8);
    color:#ffffff;
    pointer-events:none;
  }
  #gameover {
    position:absolute; top:50%; left:50%; transform:translate(-50%, -50%);
    font-size:32px; display:none; text-align:center;
    color:white;
    text-shadow:0 0 15px rgba(255,255,255,0.7);
  }
  button {
    margin-top:12px; padding:10px 22px; font-size:20px;
    cursor:pointer; border:none; border-radius:8px;
    background:#00aaff; color:white;
    box-shadow:0 0 12px #00aaff;
  }
  button:hover { background:#33bbff; }
</style>
</head>
<body>

<div id="ui">
  <div id="score">TIME: 0.0</div>
  <div id="best">BEST: 0.0</div>
</div>

<div id="gameover">
  <div id="result"></div>
  <button id="retry">コンテニュー</button>
</div>

<canvas id="game" width="400" height="600"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

const scoreText = document.getElementById("score");
const bestText = document.getElementById("best");
const gameOverUI = document.getElementById("gameover");
const resultText = document.getElementById("result");
const retryBtn = document.getElementById("retry");

let bestScore = parseFloat(localStorage.getItem("bestScore")) || 0;
bestText.textContent = "BEST: " + bestScore.toFixed(1);

let player, enemies, startTime, gameOver;
let enemyTimer = null;
let enemyInterval = 700;
let finalTime = 0;

function init() {
  player = { x: 200, y: 550, size: 20, speed: 5 };
  enemies = [];
  gameOver = false;
  startTime = Date.now();
  finalTime = 0;
  enemyInterval = 700;
  gameOverUI.style.display = "none";

  if (enemyTimer) clearInterval(enemyTimer);
  enemyTimer = setInterval(spawnEnemy, enemyInterval);
}

/* 背景色変化（HSV → RGB） */
function hsvToRgb(h, s, v){
  let f = (n) => {
    let k = (n + h/60) % 6;
    return v - v*s*Math.max(Math.min(k,4-k,1),0);
  };
  return `rgb(${f(5)*255|0}, ${f(3)*255|0}, ${f(1)*255|0})`;
}

function chooseEnemyColor(bgHue){
  let enemyHue = (bgHue + 180 + (Math.random()*60 - 30)) % 360;
  return `hsl(${enemyHue}, 90%, 60%)`;
}

function updateEnemySpawnRate() {
  let elapsed = (Date.now() - startTime) / 1000;
  let newInterval = Math.max(200, 700 - elapsed * 20);
  if (newInterval !== enemyInterval) {
    enemyInterval = newInterval;
    clearInterval(enemyTimer);
    enemyTimer = setInterval(spawnEnemy, enemyInterval);
  }
}

function spawnEnemy() {
  if (gameOver) return;

  let elapsed = (Date.now() - startTime) / 1000;
  let difficulty = 1 + elapsed * 0.05;

  let bgHue = ((Date.now() - startTime) / 40) % 360;
  let enemyColor = chooseEnemyColor(bgHue);

  enemies.push({
    x: Math.random() * 380,
    y: -30,
    size: 20,
    speed: (2 + Math.random() * 3) * difficulty,
    color: enemyColor
  });

  updateEnemySpawnRate();
}

let keys = {};
document.addEventListener("keydown", e => keys[e.key] = true);
document.addEventListener("keyup", e => keys[e.key] = false);

/* スマホ用タッチ操作 */
canvas.addEventListener("touchstart", e => {
  e.preventDefault();
  const touchX = e.touches[0].clientX - canvas.getBoundingClientRect().left;
  if (touchX < canvas.width / 2) player.x -= player.speed;
  else player.x += player.speed;

  if(player.x < 20) player.x = 20;
  if(player.x > 380) player.x = 380;
});

canvas.addEventListener("touchmove", e => {
  e.preventDefault();
  player.x = e.touches[0].clientX - canvas.getBoundingClientRect().left;
  if(player.x < 20) player.x = 20;
  if(player.x > 380) player.x = 380;
});

/* プレイヤー描画 */
function drawPlayer() {
  ctx.save();
  ctx.fillStyle = "#00faff";
  ctx.shadowColor = "#00ddee";
  ctx.shadowBlur = 15;
  ctx.beginPath();
  ctx.arc(player.x, player.y, player.size, 0, Math.PI * 2);
  ctx.fill();
  ctx.restore();
}

/* 敵の下向き三角 */
function drawEnemy(e) {
  ctx.save();
  ctx.fillStyle = e.color;
  ctx.shadowColor = e.color;
  ctx.shadowBlur = 12;
  ctx.beginPath();
  ctx.moveTo(e.x, e.y + e.size);
  ctx.lineTo(e.x - e.size, e.y - e.size);
  ctx.lineTo(e.x + e.size, e.y - e.size);
  ctx.closePath();
  ctx.fill();
  ctx.restore();
}

/* 衝突判定 */
function hit(a, b) {
  const dx = a.x - b.x;
  const dy = a.y - b.y;
  return Math.sqrt(dx*dx + dy*dy) < a.size + b.size;
}

function loop() {
  /* 背景色 */
  let hue = (Date.now() / 40) % 360;
  let bg = hsvToRgb(hue, 0.6, 0.25);
  ctx.fillStyle = bg;
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  /* TIME */
  let time = (Date.now() - startTime) / 1000;
  if (!gameOver) finalTime = time;
  scoreText.textContent = "TIME: " + finalTime.toFixed(1);

  if (!gameOver) {
    // キーボード操作
    if (keys["ArrowLeft"] && player.x > 20) player.x -= player.speed;
    if (keys["ArrowRight"] && player.x < 380) player.x += player.speed;

    drawPlayer();

    enemies.forEach(e => {
      e.y += e.speed;
      drawEnemy(e);
      if (hit(player, e)) endGame(time);
    });
  }

  requestAnimationFrame(loop);
}

function endGame(time) {
  gameOver = true;
  finalTime = time;

  if (time > bestScore) {
    bestScore = time;
    localStorage.setItem("bestScore", bestScore);
    bestText.textContent = "BEST: " + bestScore.toFixed(1);
  }

  resultText.textContent = "ゲームオーバー！\n生存時間: " + time.toFixed(1) + " 秒";
  gameOverUI.style.display = "block";
}

retryBtn.addEventListener("click", () => init());

init();
loop();
</script>
</body>
</html>
